import random
import logging
import datetime
import json
import os

from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ContextTypes,
    PollAnswerHandler,
)


BOT_TOKEN = os.environ.get("BOT_TOKEN")

if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN not set")

USERS_FILE = "users.json"

OWNER_ID = 7767018496  # ×¢×•×“ ×¨×’×¢ × ×©× ×” ××ª ×–×” ×œ-ID ×©×œ×š

questions = [
    # ========= ××¤×’×© 1 =========
    {
        "question": "××™ ××”××œ×—×™× ×™× ×”×‘××™× ×©×™×™×š ×œ×ª×§×•×¤×” ×”×§×œ××¡×™×ª?",
        "options": ["×•×™×•×•××œ×“×™", "×©×•×¤×Ÿ", "××•×¦×¨×˜", "×¦×³×™×™×§×•×‘×¡×§×™"],
        "correct_index": 2,
    },
    {
        "question": "××”×• ×”×××¤×™×™×Ÿ ×”×¢×™×§×¨×™ ×©×œ ×”×ª×§×•×¤×” ×”×¨×•×× ×˜×™×ª?",
        "options": [
            "×”×§×¤×“×” ×¢×œ ×›×œ×œ×™× × ×•×§×©×™× ×‘××‘× ×” ×”×™×¦×™×¨×”",
            "×©×™××•×© ×‘××•×–×™×§×” ×“×ª×™×ª ×‘×œ×‘×“",
            "×”×‘×¢×” ××™×©×™×ª ×•×¨×’×©×™×ª ×©×œ ×”××œ×—×™×Ÿ",
            "×©×™××•×© ×‘×›×œ×™ × ×©×™×¤×” ×‘×œ×‘×“",
        ],
        "correct_index": 2,
    },
    {
        "question": "×‘××™×–×• ×ª×§×•×¤×” ×”×—×œ×” ×”××•×–×™×§×” ×”×—×™×œ×•× ×™×ª ×œ×¤×¨×•×— ×œ×¦×“ ×”××•×–×™×§×” ×”×“×ª×™×ª?",
        "options": ["×™××™ ×”×‘×™× ×™×™×", "×”×¨× ×¡×× ×¡", "×‘××¨×•×§", "×¨×•×× ×˜×™×ª"],
        "correct_index": 1,
    },
    {
        "question": "××” ×”×”×‘×“×œ ×”×¢×™×§×¨×™ ×‘×™×Ÿ ×ª×–××•×¨×ª ×§×××¨×™×ª ×œ×ª×–××•×¨×ª ×¡×™××¤×•× ×™×ª?",
        "options": [
            "×¡×•×’ ×”××•×–×™×§×” ×©×× ×’× ×™×",
            "×’×•×“×œ ×”×ª×–××•×¨×ª",
            "×‘×ª×–××•×¨×ª ×§×××¨×™×ª ××™×Ÿ ×›×œ×™ × ×©×™×¤×”",
            "×§×™×•××• ×©×œ ×× ×¦×—",
        ],
        "correct_index": 1,
    },
    {
        "question": "××” ×ª×¤×§×™×“×• ×©×œ ×”×× ×¦×— ×‘×ª×–××•×¨×ª?",
        "options": [
            "×œ×§×‘×•×¢ ××ª ×”×˜××¤×• (×”××”×™×¨×•×ª) ×©×œ ×”× ×’×™× ×”",
            "×œ×¤×¨×© ××ª ×›×•×•× ×ª ×”××œ×—×™×Ÿ",
            "×œ×›×•×•×Ÿ ××ª ×”×ª×–××•×¨×ª",
            "×ª×©×•×‘×•×ª ××³ ×•-×‘×³ × ×›×•× ×•×ª",
        ],
        "correct_index": 3,
    },
    {
        "question": "×”×™×›×Ÿ × ×•×¦×¨×• ×”××–××•×¨×™× ×”×’×¨×’×•×¨×™×× ×™×™×?",
        "options": [
            "×‘×‘×ª×™ ×”××œ×•×›×” ×‘××™×¨×•×¤×”",
            "×‘×›× ×¡×™×•×ª ×•×‘×× ×–×¨×™×",
            "×‘××§×“××™×•×ª ×œ××•×–×™×§×”",
            "××”×ª×¤×ª×—×•×ª ×©×œ ××•×–×™×§×” ×¢×××™×ª",
        ],
        "correct_index": 1,
    },
    {
        "question": "××™×–×” ×—×™×“×•×© ×‘×•×œ×˜ ×××¤×™×™×Ÿ ××ª ×ª×—×™×œ×ª ×ª×§×•×¤×ª ×”×‘××¨×•×§?",
        "options": [
            "×”××¦××ª ×”×¡×™××¤×•× ×™×”",
            "××¢×‘×¨ ×œ×©×™××•×© ×‘×›×œ×™× ×—×©××œ×™×™×",
            "×‘×™×˜×•×œ ×”××§×”×œ×”",
            "×”××¦××ª ×”××•×¤×¨×”",
        ],
        "correct_index": 3,
    },
    {
        "question": "×›×™×¦×“ ×”×©×ª× ×ª×” ×”×ª×–××•×¨×ª ×‘×™×Ÿ ×”×ª×§×•×¤×” ×”×‘××¨×•×§×™×ª ×œ×‘×™×Ÿ ×”×¨×•×× ×˜×™×ª?",
        "options": [
            "× ×©××¨×” ×œ×œ× ×©×™× ×•×™ ××©××¢×•×ª×™",
            "× ×¢×©×ª×” ×§×˜× ×” ×•×¤×©×•×˜×” ×™×•×ª×¨",
            "×’×“×œ×” ×•×›×œ×œ×” ×™×•×ª×¨ ×¡×•×’×™× ×©×œ ×›×œ×™ × ×’×™× ×”",
            "× ×•×¡×¤×• ×¡×§×¡×•×¤×•× ×™× ×œ×”×¨×›×‘ ×”×ª×–××•×¨×ª",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” ××©××¢×•×ª ×¡×“×¨ ×”×™×©×™×‘×” ×‘×ª×–××•×¨×ª?",
        "options": [
            "× ×§×‘×¢ ×¢×œ ×¤×™ ×•×•×ª×§ ×”× ×’× ×™× ×‘×œ×‘×“",
            "× ×•×¢×“ ×œ×™×¦×•×¨ ××™×–×•×Ÿ ××§×•×¡×˜×™ ×‘×™×Ÿ ×§×‘×•×¦×•×ª ×”×›×œ×™×",
            "×ª×œ×•×™ ××š ×•×¨×§ ×‘×¨×¦×•×Ÿ ×”×× ×¦×—",
            "× ×§×‘×¢ ×‘××•×¤×Ÿ ×©×™×”×™×” ×”×›×™ ××œ×’× ×˜×™ ×œ××¨××”",
        ],
        "correct_index": 1,
    },
    {
        "question": "×œ××•×¨×š ×”×ª×§×•×¤×•×ª, ×”×©×™× ×•×™ ×‘××•×–×™×§×” ×‘× ×œ×™×“×™ ×‘×™×˜×•×™ ×‘××•×¤×Ÿ ×”×‘×:",
        "options": [
            "××•×–×™×§×” ×¢× ×˜××¤×• ××”×™×¨ ×™×•×ª×¨",
            "××•×–×™×§×” ×™×•×ª×¨ ×¤×©×•×˜×” ×•×¢× ×¤×—×•×ª ×›×œ×œ×™×",
            "××•×–×™×§×” ×™×•×ª×¨ ××•×¨×›×‘×ª ×•×¢× ×¤×—×•×ª ×›×œ×œ×™×",
            "××•×–×™×§×” ××”×™×¨×” ×¢× ×™×•×ª×¨ ×›×œ×œ×™×",
        ],
        "correct_index": 2,
    },

    # ========= ××¤×’×© 2 =========
    {
        "question": "××”×• ×”×”×‘×“×œ ×”×¢×™×§×¨×™ ×‘×™×Ÿ ×¡×•×’×” (×–'×× ×¨) ×œ×‘×™×Ÿ ×¦×•×¨×”?",
        "options": [
            "×¡×•×’×” ×¢×•×¡×§×ª ×‘××‘× ×” ×›×œ ×¤×¨×§ ×‘×™×¦×™×¨×” ×•×¦×•×¨×” ××ª×™×™×—×¡×ª ×œ×¡×“×¨ ×”×¤×¨×§×™× ×‘×”",
            "×¡×•×’×” ×¢×•×¡×§×ª ×‘××•×¤×™ ×”×™×¦×™×¨×”, ×•×¦×•×¨×” ×‘××‘× ×” ×©×œ×”",
            "×¦×•×¨×” ×¢×•×¡×§×ª ×‘×¡×’× ×•×Ÿ ×”×”×œ×—× ×” ×•×¡×•×’×” ××’×“×™×¨×” ××ª ×¡×•×’ ×”×™×¦×™×¨×”",
            "××™×Ÿ ×”×‘×“×œ â€“ ×©× ×™ ×”××•×©×’×™× ×–×”×™×",
        ],
        "correct_index": 1,
    },
    {
        "question": "××”×™ ×¡×™××¤×•× ×™×”?",
        "options": [
            "×™×¦×™×¨×” ×œ×¡×•×œ×Ÿ ×•×ª×–××•×¨×ª",
            "×™×¦×™×¨×” ×œ×ª×–××•×¨×ª ×¢× ××¡×¤×¨ ×¤×¨×§×™×",
            "×™×¦×™×¨×” ×§×¦×¨×” ×œ×¤×ª×™×—×”",
            "×™×¦×™×¨×” ×œ××§×”×œ×”",
        ],
        "correct_index": 1,
    },
    {
        "question": "×›××” ×¤×¨×§×™× ××•×¤×™×¢×™× ×‘×“×¨×š ×›×œ×œ ×‘×¡×™××¤×•× ×™×” ×œ×¢×•××ª ×§×•× ×¦×³×¨×˜×•?",
        "options": [
            "×©×œ×•×©×” ×‘×©× ×™×”×",
            "×©×œ×•×©×” ×‘×¡×™××¤×•× ×™×” ×•××¨×‘×¢×” ×‘×§×•× ×¦×³×¨×˜×•",
            "××¨×‘×¢×” ×‘×¡×™××¤×•× ×™×” ×•×©×œ×•×©×” ×‘×§×•× ×¦×³×¨×˜×•",
            "××™×Ÿ ×¡×˜× ×“×¨×˜ ×§×‘×•×¢",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” ××”×‘××™× ××™× ×• ××“×•×™×§ ×œ×’×‘×™ ×™×—×¡×™ ×”×¡×•×œ×Ÿ ×•×”×ª×–××•×¨×ª ×‘×§×•× ×¦'×¨×˜×•?",
        "options": [
            "×”×¡×•×œ×Ÿ ×ª××™×“ ×× ×’×Ÿ ××ª ×”×× ×’×™× ×” ×•×”×ª×–××•×¨×ª ××œ×•×•×” ××•×ª×•",
            "×‘×“×¨×š ×›×œ×œ ×™×© ×¤×ª×™×—×” ×ª×–××•×¨×ª×™×ª ×œ×¤× ×™ ×›× ×™×¡×ª ×”×¡×•×œ×Ÿ, ×›×œ×•××¨ ×ª×¦×•×’×” ×›×¤×•×œ×”",
            "×§×•× ×¦×³×¨×˜×• ×™×›×•×œ ×œ×”×™×•×ª ×œ×¡×•×œ×Ÿ ×™×—×™×“ ××š ×’× ×œ××¡×¤×¨ ×¡×•×œ× ×™× ×¢× ×”×ª×–××•×¨×ª",
            "×‘×“×¨×š ×›×œ×œ ×‘×¢×œ 3 ×¤×¨×§×™×: ××”×™×¨-××™×˜×™-××”×™×¨",
        ],
        "correct_index": 0,
    },
    {
        "question": "××”×™ ××•×‘×¨×˜×•×¨×”?",
        "options": [
            "×¤×¨×§ ×¨××©×•×Ÿ ×©×œ ×¡×™××¤×•× ×™×”",
            "×¤×ª×™×—×” ×œ××•×¤×¨×” / ×‘×œ×˜ / ××—×–×” ××• ×™×¦×™×¨×” ×©×¢×•××“×ª ×‘×¤× ×™ ×¢×¦××”",
            "×¤×¨×§ ×‘×™× ×™×™× ×‘×ª×•×š ×¡×•×•×™×˜×”",
            "×™×¦×™×¨×” ×œ×œ× ××‘× ×” ××•×’×“×¨",
        ],
        "correct_index": 1,
    },
    {
        "question": "××™×–×• ××”×§×‘×•×¦×•×ª ×”×‘××•×ª ×›×•×œ×œ×ª ×’× ×¡×•×’×•×ª (×–×³×× ×¨×™×) ×•×’× ×¦×•×¨×•×ª?",
        "options": [
            "×¤×•×××” ×¡×™××¤×•× ×™×ª, ×¡×™××¤×•× ×™×”, ×§×•× ×¦×³×¨×˜×•",
            "×¡×•× ×˜×”, ××•×‘×¨×˜×•×¨×”, ×¡×•×•×™×˜×”",
            "××™× ×•××˜ ×•×˜×¨×™×•, ××—×¨×•×–×ª, × ×•×©× ×•×•×¨×™××¦×™×•×ª",
            "××•×‘×¨×˜×•×¨×”, ×¨×•× ×“×•, ××•×¤×¨×”",
        ],
        "correct_index": 3,
    },
    {
        "question": "××™×–×” ××”×¦×•×¨×•×ª ×”×‘××•×ª ××™× ×• ××§×¨×” ×¤×¨×˜×™ ×©×œ ×¦×•×¨×ª ABA?",
        "options": ["××™× ×•××˜ ×•×˜×¨×™×•", "× ×•×©× ×•×•×¨×™××¦×™×•×ª", "×¦×•×¨×ª ×¡×•× ×˜×”", "×¡×§×¨×¦×• ×•×˜×¨×™×•"],
        "correct_index": 1,
    },
    {
        "question": "××” ×¡×“×¨ ×”×—×œ×§×™× ×”××¨×›×–×™×™× ×‘×¦×•×¨×ª ×¡×•× ×˜×”?",
        "options": [
            "×ª×¦×•×’×”, ×¤×™×ª×•×—, ××—×–×¨",
            "××‘×•×, ×¤×™×ª×•×—, ×ª×¦×•×’×”",
            "×§×•×“×”, ×ª×¦×•×’×”, ×¤×™×ª×•×—, ××—×–×¨",
            "×ª×¦×•×’×”, ××—×–×¨, ×§×•×“×”",
        ],
        "correct_index": 0,
    },
    {
        "question": "××” ×”×‘××™× ××™× ×• ×—×œ×§ ×©×œ ×”×´×ª×¦×•×’×”×´ ×‘×¦×•×¨×ª ×¡×•× ×˜×”?",
        "options": ["× ×•×©× ×¨××©×•×Ÿ ×•×©× ×™", "× ×•×©× ×¡×™×•×", "××‘×•× ××™×˜×™", "×§×•×“×˜×”"],
        "correct_index": 2,
    },
    {
        "question": "××™×–×” ×¤×¨×§ ×‘×¡×™××¤×•× ×™×” ×”×§×œ××¡×™×ª ×™×”×™×” ×œ×¨×•×‘ ×¨×™×§×•×“×™? (××™× ×•××˜ / ×¡×§×¨×¦×• ×¢× ×˜×¨×™×•)",
        "options": ["×¨××©×•×Ÿ", "×©× ×™", "×©×œ×™×©×™", "×¨×‘×™×¢×™"],
        "correct_index": 2,
    },

    # ========= ××¤×’×© 3 =========
    {
        "question": "×”×”×‘×“×œ ×‘×™×Ÿ ARCO ×œ-PIZZICATO:",
        "options": [
            "×˜×›× ×™×§×•×ª ×©×•× ×•×ª ×©×œ ×”×¤×§×ª ×¦×œ×™×œ ×‘×›×œ×™ ××™×ª×¨",
            "×ª×™××•×¨ ××”×™×¨×•×™×•×ª ×©×•× ×•×ª ×©×œ × ×’×™× ×ª ×”×™×¦×™×¨×”",
            "×”×©×™××•×© ×‘×§×©×ª ×œ×¢×•××ª ×¤×¨×™×˜×” ×‘××¦×‘×¢×•×ª",
            "×ª×©×•×‘×•×ª ××³ ×•-×’×³ × ×›×•× ×•×ª",
        ],
        "correct_index": 3,
    },
    {
        "question": "××”×• ×ª×¤×§×™×“×• ×©×œ ×”×’×©×¨ ×‘×›×™× ×•×¨?",
        "options": [
            "×œ×™×™×¤×•×ª ××ª ×”×›×œ×™ ××‘×—×™× ×” ×—×–×•×ª×™×ª",
            "×œ×”×¨×™× ××ª ×”××™×ª×¨×™× ×•×œ×”×¢×‘×™×¨ ××ª ×”×¨×˜×˜ ×œ×ª×™×‘×ª ×”×ª×”×•×“×”",
            "×œ×¢×¦×•×¨ ××ª ×”××™×ª×¨×™× ××œ×”×™×©×‘×¨",
            "×œ×‘×¦×¢ ××ª ×›×™×•×•×Ÿ ×”××™×ª×¨×™×",
        ],
        "correct_index": 1,
    },
    {
        "question": "××™×–×” ××©×¤×˜ ××™× ×• × ×›×•×Ÿ ×œ×’×‘×™ ×”×§×©×ª?",
        "options": [
            "×§×•×‘×¢×ª ×× ×™×”×™×” ×¦×œ×™×œ ×¨×¦×•×£ ××• ×¦×œ×™×œ×™× ××•×¤×¨×“×™×",
            "×× ×¨×•×¦×™× ×œ× ×’×Ÿ ×¦×œ×™×œ×™× ×¢×“×™× ×™× ×•×—×œ×©×™× ×¢×“×™×£ ×œ× ×’×Ÿ ×‘×—×œ×§ ×”×¢×œ×™×•×Ÿ ×©×œ×”",
            "×”××©×§×œ ×”×©×•× ×” ×©×œ ×”×§×©×ª ×‘×›×œ ×¦×“ ×©×œ×” ××©×¤×™×¢ ×¢×œ ×—×•×–×§ ×”×¦×œ×™×œ",
            "××™×Ÿ ×—×©×™×‘×•×ª ×œ×›×™×•×•×Ÿ ××©×™×›×ª ×”×§×©×ª",
        ],
        "correct_index": 3,
    },
    {
        "question": "××”×™ \"×”× ×©××”\" ×‘×›×œ×™ ××™×ª×¨?",
        "options": [
            "××ª×™×™×—×¡×ª ×œ××™×›×•×ª ×”× ×’×™× ×” ×¢×œ ×”×›×œ×™",
            "×©× ×™ ×¤×ª×—×™× ×‘×¦×•×¨×ª f ×‘×’×•×£ ×”×›×™× ×•×¨",
            "××•×˜ ×¢×¥ ×¤× ×™××™ ×©××¢×‘×™×¨ ×¨×˜×˜ ×‘×™×Ÿ ×”×—×œ×§ ×”×¢×œ×™×•×Ÿ ×œ×ª×—×ª×•×Ÿ ×©×œ ×”×›×œ×™",
            "×›×™× ×•×™ ×œ×¦×•×•××¨ ×”×›×œ×™",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”×™ ×”××©××¢×•×ª ×”×¤×™×–×™×§×œ×™×ª ×©×œ ×§×™×¦×•×¨ ×”××™×ª×¨?",
        "options": [
            "×”×¦×œ×™×œ × ×”×™×” × ××•×š ×™×•×ª×¨",
            "×”×¦×œ×™×œ × ×”×™×” ×—×–×§ ×™×•×ª×¨",
            "×”×¦×œ×™×œ ××ª×§×¦×¨",
            "×”×¦×œ×™×œ × ×”×™×” ×’×‘×•×” ×™×•×ª×¨",
        ],
        "correct_index": 3,
    },
    {
        "question": "××”×™ ×˜×›× ×™×§×ª \"×§×•× ×˜×¨×¤×•× ×§×˜\"?",
        "options": [
            "× ×’×™× ×” ×©×œ ×× ×’×™× ×” ×‘×•×“×“×ª",
            "×©×™×œ×•×‘ ×©×œ ××¡×¤×¨ ×§×•×•×™× ××œ×•×“×™×™× ×¢×¦×××™×™×",
            "×¤×¨×™×˜×” ×¢×œ ××™×ª×¨×™ ×”×§×•× ×˜×¨×‘×¡",
            "×©×™××•×© ×¨×§ ×‘×›×œ×™ ××™×ª×¨",
        ],
        "correct_index": 1,
    },
    {
        "question": "××™×–×” ××©×¤×˜ × ×›×•×Ÿ ×‘×”×§×©×¨ ×©×œ \"×¤×•×’×”\"?",
        "options": [
            "×™×© × ×•×©× ×©×× ×•×’×Ÿ ×›×œ ×¤×¢× ×‘×§×•×œ ××—×¨",
            "×›×œ ×§×•× ×˜×¨×¤×•× ×§×˜ ×”×•× ×‘×¢×¦× ×¤×•×’×”",
            "×‘×¤×•×’×” ×—×™×™×‘×™× ×œ×”×™×•×ª 3 ××• 4 ×§×•×œ×•×ª",
            "×›×œ ×”×§×•×œ×•×ª ×‘×¤×•×’×” ×©×•×•×™× ×›×œ ×”×–××Ÿ",
        ],
        "correct_index": 0,
    },
    {
        "question": "××™×œ×• ××”×‘××™× ××ª××¨ ××ª ×™.×¡. ×‘××š?",
        "options": [
            "×”×¡×’× ×•×Ÿ ×©×œ×• ×”×™×” × ×—×©×‘ ×œ××™×•×©×Ÿ ×‘×ª×§×•×¤×ª ×—×™×™×•",
            "×”×™×• ×œ×• 10 ×™×œ×“×™× ×‘×•×’×¨×™×, ××”× ×›××” ××•×–×™×§××™× ××¤×•×¨×¡××™×",
            "×›×ª×‘ ×¨×§ ××•×–×™×§×” ×§×•×œ×™×ª-×“×ª×™×ª",
            "×ª×©×•×‘×•×ª ××³ ×•-×‘×³ × ×›×•× ×•×ª",
        ],
        "correct_index": 3,
    },
    {
        "question": "××” ×”×××¤×™×™×Ÿ ×”××¨×›×–×™ ×©×œ ×”××•×–×™×§×” ×©×œ ××•×¦×¨×˜?",
        "options": [
            "×›×ª×‘ ×‘×¢×™×§×¨ ××•×–×™×§×” ×œ×¤×¡× ×ª×¨",
            "×›×ª×‘ ×™×¦×™×¨×•×ª ×××•×“ ××™×›×•×ª×™×•×ª, ××‘×œ ××¢×˜ ×××•×“ ×‘×™×—×¡ ×œ××œ×—×™× ×™× ××—×¨×™×",
            "×©×™×œ×‘ ×¡×’× ×•× ×•×ª ××›×œ ××™×¨×•×¤×” ×”×•×“×•×ª ×œ××¡×¢×•×ª×™×• ×‘×¦×¢×™×¨×•×ª×•",
            "×›×ª×‘ ×‘×¢×™×§×¨ ×‘×¡×’× ×•×Ÿ ×§×•× ×˜×¨×¤×•× ×§×˜",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”×• ×¡×•×œ×?",
        "options": [
            "×—×œ×§ ×‘×›×™× ×•×¨, ×‘×“×´×› ××¤×œ×¡×˜×™×§, ×©×××¤×©×¨ ×œ×”×¢×œ×•×ª ××•×ª×• ×¢×œ ×”×›×ª×£",
            "×¨×¦×£ ×©×œ ×¦×œ×™×œ×™× ×¢×•×§×‘×™×",
            "×›×™× ×•×™ ×œ× ×•×©× ×”××¨×›×–×™ ×‘×¤×•×’×”",
            "×˜×›× ×™×§×ª × ×’×™× ×” ×‘×›×™× ×•×¨ ×‘×” ×”×§×©×ª ××˜×¤×¡×ª ×•×¢×•×œ×” ×œ×›×™×•×•×Ÿ ×”×’×©×¨",
        ],
        "correct_index": 1,
    },

    # ========= ××¤×’×© 4 =========
    {
        "question": "××™×–×” ×›×œ×™ ×©×™×™×š ×œ××©×¤×—×ª ×”×¡×•×¤×™×ª ×”×›×¤×•×œ×”?",
        "options": ["×§×œ×¨×™× ×˜", "××‘×•×‘", "×—×œ×™×œ ×¦×“", "×¤×™×§×•×œ×•"],
        "correct_index": 1,
    },
    {
        "question": "××™×š ××•×¤×§ ×”×¦×œ×™×œ ×‘×—×œ×™×œ ×¦×“?",
        "options": [
            "× ×©×™×¤×” ×“×¨×š ×¢×œ×” ×¡×•×£",
            "× ×©×™×¤×” ×œ×ª×•×š ×¤×™×™×”",
            "× ×©×™×¤×” ×¢×œÖ¾×¤× ×™ ×—×•×¨ ×¦×“×“×™ ×©×’×•×¨××ª ×œ×¨×˜×˜ ×”××•×•×™×¨",
            "×¤×¨×™×˜×” ×¢×œ ××™×ª×¨",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”×™ ×”×“×¨×š ×”×¢×™×§×¨×™×ª ×œ×”×¤×§×ª ×¦×œ×™×œ ×‘×›×œ×™ × ×©×™×¤×” ×××ª×›×ª?",
        "options": [
            "× ×©×™×¤×” ×—×–×§×”",
            "×¨×˜×™×˜×ª ×”×©×¤×ª×™×™× ××œ ×ª×•×š ×”×¤×™×™×”",
            "× ×©×™×¤×” ×¢×œ ×—×•×¨ ×¦×“×“×™",
            "×©×™××•×© ×‘×¢×œ×” ×¡×•×£",
        ],
        "correct_index": 1,
    },
    {
        "question": "××” ×”×”×‘×“×œ ×‘×™×Ÿ ×—×¦×•×¦×¨×•×ª ×•×§×¨× ×•×ª ×˜×‘×¢×™×•×ª ×œ××•×“×¨× ×™×•×ª (×”×—×œ ××××¦×¢ ×”×××” ×”-19)?",
        "options": [
            "×‘×›×œ×™× ×”×˜×‘×¢×™×™× ×™×© ×©×¡×ª×•××™×",
            "×‘×›×œ×™× ×”××•×“×¨× ×™×™× ××™ ××¤×©×¨ ×œ× ×’×Ÿ ××ª ×›×œ ×”×¦×œ×™×œ×™× ×©×œ ×”×¡×“×¨×” ×”×”×¨××•× ×™×ª ×”×˜×‘×¢×™×ª",
            "×‘×›×œ×™× ×˜×‘×¢×™×™× ××¤×©×¨ ×œ× ×’×Ÿ ×¨×§ ××ª ×”×¦×œ×™×œ×™× ×©×œ ×”×¡×“×¨×” ×”×”×¨××•× ×™×ª ×”×˜×‘×¢×™×ª",
            "×”×”×‘×“×œ ×”×•× ×‘×’×•×•×Ÿ ×”×¦×œ×™×œ",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” ×§×•×‘×¢ ××ª ×’×•×‘×” ×”×¦×œ×™×œ ×‘×›×œ×™ × ×©×™×¤×”?",
        "options": [
            "×¦×‘×¢ ×”×›×œ×™",
            "×¡×•×’ ×”×§×©×ª",
            "××•×¨×š ×”×¦×™× ×•×¨ ×•×—×•×–×§ ×”× ×©×™×¤×”",
            "×œ×—×¥ ×”××•×•×™×¨ ×‘×œ×‘×“",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”×• ×”×”×‘×“×œ ×‘×™×Ÿ ×—×¦×•×¦×¨×” ×œ×§×¨×Ÿ ×™×¢×¨?",
        "options": [
            "××™×Ÿ ×”×‘×“×œ",
            "×—×¦×•×¦×¨×” ××©×ª××©×ª ×‘×¢×œ×” ×¡×•×£",
            "×¦×•×¨×ª ×”×¦×™× ×•×¨ ×•×”×¤×™×™×” ×©×•× ×•×ª ×•××©×¤×™×¢×•×ª ×¢×œ ×”×¦×œ×™×œ",
            "×”×§×¨×Ÿ ×¢×©×•×™×” ××¢×¥",
        ],
        "correct_index": 2,
    },
    {
        "question": "×›×œ×™ ×”×§×©×” ×œ×œ× ×¤×™×¥×³ ×××•×¤×™×™× ×™× ×‘×›×š:",
        "options": [
            "××¤×™×§×™× ×’×•×‘×” ×¦×œ×™×œ ××•×’×“×¨",
            "××•×¤×™×¢×™× ×¨×§ ×‘××•×–×™×§×” ××ª× ×™×ª",
            "××¤×™×§×™× ×¦×œ×™×œ ×¨×¢×©× ×™ ×œ×œ× ×’×•×‘×” ×‘×¨×•×¨",
            "×× ×•×’× ×™× ×¨×§ ×¢× ××§×œ×•×ª",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” ××©×•×ª×£ ×œ×”×™×™×“×Ÿ, ××•×¦×¨×˜ ×•×‘×˜×”×•×‘×Ÿ?",
        "options": [
            "×©×œ×•×©×ª× ××œ×—×™× ×™× ××”×ª×§×•×¤×” ×”×¨×•×× ×˜×™×ª",
            "×©×œ×•×©×ª× ×¤×¢×œ×• ×‘×•×™× ×” ×•×¢×™×¦×‘×• ××ª ×”×¡×’× ×•×Ÿ ×”×§×œ××¡×™",
            "×›×ª×‘×• ×¤×—×•×ª ×Ö¾40 ×¡×™××¤×•× ×™×•×ª",
            "×”×™×• ×‘× ×™ ××•×ª×• ×“×•×¨",
        ],
        "correct_index": 1,
    },
    {
        "question": "××”×• ×××¤×™×™×Ÿ ××¨×›×–×™ ×‘×›×ª×™×‘×ª ×‘×˜×”×•×‘×Ÿ?",
        "options": [
            "×¡×’× ×•×Ÿ ×¤×©×•×˜",
            "×©×™××•×© ××•×¢×˜ ×‘×›×œ×™ × ×©×™×¤×” ×××ª×›×ª",
            "×”×¨×—×‘×ª ×’×‘×•×œ×•×ª ×”××‘× ×” ×”×¡×™××¤×•× ×™ ×•×§×•× ×˜×¨×¡×˜×™× ×—×–×§×™×",
            "×›×ª×™×‘×” ×¨×§ ×œ××§×œ×“×ª",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” ×”×™×” × ×—×©×‘ ×¤×•×¨×¥ ×“×¨×š ×‘×¡×™××¤×•× ×™×” ×”×ª×©×™×¢×™×ª ×©×œ ×‘×˜×”×•×‘×Ÿ ×‘×ª×§×•×¤×ª ×›×ª×™×‘×ª×”?",
        "options": [
            "×©×™×œ×•×‘ ××§×”×œ×” ×•×–××¨×™×Ö¾×¡×•×œ× ×™×",
            "×©×™×œ×•×‘ â€œ×ª×–×›×•×¨×•×ªâ€ ××”×¤×¨×§×™× ×”×§×•×“××™× ×‘××”×œ×š ×”×¤×¨×§ ×”××—×¨×•×Ÿ",
            "×¦×œ×™×œ×™ ×”×¤×ª×™×—×” ×©×œ ×”×¤×¨×§ ×”×¨×‘×™×¢×™",
            "×›×œ ×”×ª×©×•×‘×•×ª × ×›×•× ×•×ª",
        ],
        "correct_index": 3,
    },

    # ========= ××¤×’×© 5 =========
    {
        "question": "××™×–×” ××”×‘××™× ×œ× ×§×“× ×œ×¤×¡× ×ª×¨ ×”××•×“×¨× ×™ ×‘×”×™×¡×˜×•×¨×™×” ×©×œ ×›×œ×™ ×”××§×œ×“×ª?",
        "options": ["×¢×•×’×‘", "×¦×³××‘×œ×•", "××§×•×¨×“×™×•×Ÿ", "×¤×¡× ×ª×¨ ×¤×˜×™×©×™× (×”×××¨ ×§×œ×•×•×™×¨)"],
        "correct_index": 2,
    },
    {
        "question": "××” ×”×™×” ×”×—×™×“×•×© ×”××¨×›×–×™ ×©×œ ×¤×¡× ×ª×¨ ×”×¤×˜×™×©×™× ×œ×¢×•××ª ×”×¦×³××‘×œ×•?",
        "options": [
            "××¤×©×¨×•×ª ×œ× ×’×Ÿ ××”×¨ ×™×•×ª×¨",
            "××¤×©×¨×•×ª ×œ×©×œ×•×˜ ×‘×¢×•×¦××” (×—×–×§â€“×—×œ×©) ×‘×××¦×¢×•×ª ×”× ×’×™× ×”",
            "××¡×¤×¨ ×’×“×•×œ ×™×•×ª×¨ ×©×œ ×§×œ×™×“×™×",
            "×©×™××•×© ×¨×§ ×‘×™×“ ××—×ª",
        ],
        "correct_index": 1,
    },
    {
        "question": "×‘××™×–×• ×ª×§×•×¤×” ×”×—×œ ×”×¤×¡× ×ª×¨ ×œ×”×•×¤×™×¢ ×›×—×œ×§ ××”×ª×–××•×¨×ª ×”×¡×™××¤×•× ×™×ª?",
        "options": [
            "×ª×§×•×¤×” ×§×œ××¡×™×ª",
            "×ª×§×•×¤×” ×¨×•×× ×˜×™×ª",
            "×ª×§×•×¤×” ××•×“×¨× ×™×ª (×××” 20)",
            "×ª×§×•×¤×ª ×”×‘××¨×•×§",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” ×××¤×™×™×Ÿ ×§×•× ×¦×³×¨×˜×™ ×œ×¤×¡× ×ª×¨ ×©×œ ××•×¦×¨×˜ ×•×‘×˜×”×•×‘×Ÿ?",
        "options": [
            "×”×¤×¡× ×ª×¨ ××œ×•×•×” ××ª ×”×ª×–××•×¨×ª ×‘×œ×‘×“",
            "×“×™××œ×•×’ ×‘×™×Ÿ ×”×¡×•×œ×Ÿ ×œ×ª×–××•×¨×ª",
            "× ×’×™× ×” ×©×œ ×”×¤×¡× ×ª×¨ ×œ×œ× ×ª×–××•×¨×ª",
            "×©×™××•×© ×¨×§ ×‘×›×œ×™ ××™×ª×¨",
        ],
        "correct_index": 1,
    },
    {
        "question": "××—×“ ×”×××¤×™×™× ×™× ×©×œ ×§×•× ×¦×³×¨×˜×™ ×œ×¤×¡× ×ª×¨ ×‘×ª×§×•×¤×” ×”×¨×•×× ×˜×™×ª ×”×:",
        "options": [
            "×¤×ª×™×—×” ×•×™×¨×˜×•××•×–×™×ª ×©×œ ×”×¤×¡× ×ª×¨ ××™×“ ×‘×ª×—×™×œ×ª ×”×§×•× ×¦×³×¨×˜×•",
            "×”×™×¦××“×•×ª ×œ××‘× ×” ×”×§×•× ×¦×³×¨×˜×• ×©×”×™×” ××§×•×‘×œ ×‘×ª×§×•×¤×” ×”×§×œ××¡×™×ª",
            "×§×“× ×¦×•×ª ×œ× ×›×ª×•×‘×•×ª ×‘××•×¤×Ÿ ××¤×•×¨×©",
            "×›×œ ×”×ª×©×•×‘×•×ª × ×›×•× ×•×ª",
        ],
        "correct_index": 0,
    },
    {
        "question": "××” ×××¤×™×™×Ÿ ××ª ×™×¦×™×¨×ª×• ×©×œ ×©×•×¤×Ÿ?",
        "options": [
            "×›×ª×™×‘×” ×‘×¢×™×§×¨ ×œ××•×¤×¨×•×ª",
            "×›×ª×™×‘×” ×ª×–××•×¨×ª×™×ª ×¨×—×‘×ªÖ¾×”×™×§×£",
            "×”×ª××§×“×•×ª ×›××¢×˜ ×‘×œ×¢×“×™×ª ×‘×¤×¡× ×ª×¨",
            "×›×ª×‘ ×‘×¢×™×§×¨ ××•×–×™×§×” ×“×ª×™×ª",
        ],
        "correct_index": 2,
    },
    {
        "question": "××” × ×›×•×Ÿ ×œ×’×‘×™ ×‘×¨×”××¡?",
        "options": [
            "×›×ª×‘ ×¨×§ ×™×¦×™×¨×•×ª ×œ×¤×¡× ×ª×¨",
            "×›×ª×‘ ×¡×™××¤×•× ×™×” ××—×ª ×‘×œ×‘×“",
            "×›×ª×‘ ×”×¨×‘×” ××•×¤×¨×•×ª",
            "×”×ª×—×™×œ ×œ×›×ª×•×‘ ×¡×™××¤×•× ×™×•×ª ×‘×’×™×œ ×××•×—×¨",
        ],
        "correct_index": 3,
    },
    {
        "question": "××”×• ×”×”×‘×“×œ ×”×›×œ×œ×™ ×‘×™×Ÿ ××’×³×•×¨ ×œ××™× ×•×¨?",
        "options": [
            "××’×³×•×¨ ×ª××™×“ ××™×˜×™ ×™×•×ª×¨",
            "××™× ×•×¨ ×ª××™×“ ×—×–×§ ×™×•×ª×¨",
            "××’×³×•×¨ × ×ª×¤×¡ ×›×‘×”×™×¨ ×™×•×ª×¨ (×©××—), ××™× ×•×¨ ×›×§×•×“×¨ ×™×•×ª×¨ (×¢×¦×•×‘)",
            "××™× ×•×¨ ××©××¢×•×ª×• \"×’×“×•×œ\" ×‘××™×˜×œ×§×™×ª ×•××’×³×•×¨ ××©××¢×•×ª×• \"×§×˜×Ÿ\"",
        ],
        "correct_index": 2,
    },
    {
        "question": "××§×•×¨×“ ××’×³×•×¨ ×”×•×:",
        "options": [
            "×¦×™×¨×•×£ ×©×œ 3 ×¦×œ×™×œ×™× ××ª×•×š ×¡×•×œ× ××™× ×•×¨",
            "×¦×™×¨×•×£ ×©×œ 3 ×¦×œ×™×œ×™× ××ª×•×š ×¡×•×œ× ××’×³×•×¨",
            "×›×œ ×©×™×œ×•×‘ ×©×œ ×©× ×™ ×¦×œ×™×œ×™× ××• ×™×•×ª×¨",
            "×›×•×œ×œ ×œ×¤×—×•×ª 4 ×¦×œ×™×œ×™× ×©×•× ×™×",
        ],
        "correct_index": 1,
    },

    # ========= ××¤×’×© 6 =========
    {
        "question": "××” ××™×™×—×“ ××ª ×”×§×•×œ ×”×× ×•×©×™ ×œ×¢×•××ª ×›×œ×™ × ×’×™× ×”?",
        "options": [
            "××™× ×• ×™×›×•×œ ×œ×©× ×•×ª ×’×•×‘×” ×¦×œ×™×œ",
            "××•×’×‘×œ ×œ×× ×¢×“ ×§×‘×•×¢",
            "××©×œ×‘ ×˜×§×¡×˜, ×”×‘×¢×” ×•×¦×œ×™×œ ×™×—×“",
            "××™× ×• ××ª××™× ×œ××•×–×™×§×” ×§×œ××¡×™×ª",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”× ×¡×•×’×™ ×”×§×•×œ×•×ª ×‘××§×”×œ×” ×¡×˜× ×“×¨×˜×™×ª?",
        "options": [
            "×¡×•×¤×¨×Ÿ, ××œ×˜ ×•×‘×¡",
            "×¡×•×¤×¨×Ÿ, ××œ×˜, ×˜× ×•×¨ ×•×‘×¡",
            "×¡×•×¤×¨×Ÿ, ××¦×•Ö¾×¡×•×¤×¨×Ÿ, ××œ×˜ ×•×‘×¨×™×˜×•×Ÿ",
            "××™×Ÿ ×—×œ×•×§×” ×œ×¡×•×’×™ ×§×•×œ×•×ª",
        ],
        "correct_index": 1,
    },
    {
        "question": "××™×–×• ××”×¡×•×’×•×ª ×”×‘××•×ª ×”×™× ×‘×•×•×“××•×ª ×™×¦×™×¨×” ×¢× ×§×•×œ×•×ª ×× ×•×©×™×™×?",
        "options": ["×¡×™××¤×•× ×™×”", "×§×•× ×¦×³×¨×˜×•", "××™×¡×ª ×¨×§×•×•×™××", "×¡×•×•×™×˜×”"],
        "correct_index": 2,
    },
    {
        "question": "××”×• ×©×™×¨ ××× ×•×ª×™ (Lied)?",
        "options": [
            "×©×™×¨ ×¢×××™ ×œ×œ× ×œ×™×•×•×™",
            "×©×™×¨ ×œ×§×•×œ ×•×œ×™×•×•×™ ×›×œ×©×”×•, ×œ×¨×•×‘ ×¤×¡× ×ª×¨",
            "×©×™×¨ ×œ××§×”×œ×” ×‘×œ×‘×“",
            "×§×˜×¢ ××ª×•×š ××•×¤×¨×”",
        ],
        "correct_index": 1,
    },
    {
        "question": "××”×™ ××™×¡×”?",
        "options": [
            "×™×¦×™×¨×” ×—×™×œ×•× ×™×ª ×œ×§×•×œ ×¡×•×œ×•",
            "×™×¦×™×¨×” ×ª×™××˜×¨×œ×™×ª ×¢× ×ª×¤××•×¨×”",
            "×™×¦×™×¨×” ×§×•×œ×™×ªÖ¾×“×ª×™×ª ×”××‘×•×¡×¡×ª ×¢×œ ×˜×§×¡×˜×™× ×§×‘×•×¢×™× ×‘×œ×˜×™× ×™×ª",
            "×¡×•×’ ×©×œ ××¨×™×” ××™×˜×™×ª",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”×™ ××•×¨×˜×•×¨×™×”?",
        "options": [
            "××•×¤×¨×” ×§×¦×¨×”",
            "×™×¦×™×¨×” ×§×•×œ×™×ªÖ¾×“×ª×™×ª ×¢× ×ª×–××•×¨×ª ×•×¡×•×œ× ×™×, ×œ×œ× ××©×—×§ ×•×ª×¤××•×¨×”",
            "×©×™×¨ ×œ×§×•×œ ×™×—×™×“",
            "×™×¦×™×¨×” ×“×ª×™×ª ×©× ×•×¢×“×” ×œ××©×›×‘×ª ×”××ª",
        ],
        "correct_index": 1,
    },
    {
        "question": "××” ×”×”×‘×“×œ ×”×¢×™×§×¨×™ ×‘×™×Ÿ ××¨×™×” ×œ×¨×¦×³×™×˜×˜×™×‘?",
        "options": [
            "××¨×™×” ××”×™×¨×” ×™×•×ª×¨",
            "×¨×¦×³×™×˜×˜×™×‘ ×ª××™×“ ××•×©×¨ ×‘××§×”×œ×”",
            "××¨×™×” ××‘×˜××ª ×¨×’×© ×•××œ×•×“×™×”, ×¨×¦×³×™×˜×˜×™×‘ ×“×™×‘×•×¨×™ ×•××§×“× ××ª ×”×¢×œ×™×œ×”",
            "××™×Ÿ ×”×‘×“×œ ×‘×™× ×™×”×",
        ],
        "correct_index": 2,
    },
    {
        "question": "××”×• ×¨×¦×³×™×˜×˜×™×‘ â€œ×™×‘×©â€œ?",
        "options": [
            "×¨×¦×³×™×˜×˜×™×‘ ×¢× ×ª×–××•×¨×ª ××œ××”",
            "×¨×¦×³×™×˜×˜×™×‘ ×‘×œ×™×•×•×™ ××™× ×™××œ×™ (×œ×¨×•×‘ ×¦×³××‘×œ×• ×•×‘×¡)",
            "×¨×¦×³×™×˜×˜×™×‘ ×œ×œ× ×˜×§×¡×˜",
            "×¡×•×’ ×©×œ ××¨×™×”",
        ],
        "correct_index": 1,
    },
    {
        "question": "××™ ××”××œ×—×™× ×™× ×”×‘××™× ××–×•×”×” ×‘××™×•×—×“ ×¢× ×”××•×¤×¨×” ×”××™×˜×œ×§×™×ª ×©×œ ×”×××” ×”Ö¾19?",
        "options": ["××•×¦×¨×˜", "×‘××š", "×•×¨×“×™", "×“×‘×™×¡×™"],
        "correct_index": 2,
    },
    {
        "question": "××” ×××¤×™×™×Ÿ ××¨×›×–×™ ×‘×™×¦×™×¨×•×ª ×”××•×¤×¨×” ×©×œ ×¤×•×¦×³×™× ×™?",
        "options": [
            "×›×ª×™×‘×” ××•×¤×©×˜×ª ×œ×œ× ×¨×’×©",
            "×“×’×© ×¢×œ ×“×¨××”, ×¨×’×© ×•×“××•×™×•×ª ×× ×•×©×™×•×ª",
            "×©×™××•×© ×‘×œ×¢×“×™ ×‘××§×”×œ×”",
            "×”×™×× ×¢×•×ª ×××¨×™×•×ª",
        ],
        "correct_index": 1,
    },
]


logging.basicConfig(level=logging.INFO)

# chat id ×©×œ ×”×§×‘×•×¦×” (× ×§×‘×¢ ×›×©×¢×•×©×™× /start ×‘×§×‘×•×¦×”)
QUIZ_CHAT_ID = None

# user_id -> "YYYY-MM-DD" ×©×œ ×”×™×•× ×”××—×¨×•×Ÿ ×©×”×•× ×ª×¨×’×œ
last_practice: dict[int, str] = {}


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global QUIZ_CHAT_ID
    chat = update.effective_chat

    # ×× ×–×” ×§×‘×•×¦×” / ×¡×•×¤×¨×§×‘×•×¦×” â€“ ×©×•××¨×™× ××ª ×”-chat id ×œ×©×™×™××™× ×’
    if chat.type in ("group", "supergroup"):
        QUIZ_CHAT_ID = chat.id
        where = "×‘×§×‘×•×¦×” ğŸ‘¥"
    else:
        where = "×‘×¦×³××˜ ×”×¤×¨×˜×™ ğŸ¤"

    await update.message.reply_text(
        "×”×™×™! ×× ×™ ×‘×•×˜ ×”×—×–×¨×” ×œ××‘×—×Ÿ ×‘×—×•×•×™×” ××•×–×™×§×œ×™×ª ğŸµ\n"
        "×©×œ×—×• /quiz ×›×“×™ ×œ×§×‘×œ ×©××œ×”.\n"
        "××¤×©×¨ ×’× /quiz20 ×œ××‘×—×Ÿ ×©×œ 20 ×©××œ×•×ª.\n"
        "×•-/quiz_all ×œ××‘×—×Ÿ ×¢×œ ×›×œ ×”×—×•××¨.\n"
        "×‘×§×‘×•×¦×”: ×›×œ ××—×“ ×™×›×•×œ ×œ×¢×©×•×ª /register ×›×“×™ ×œ×”×™×›× ×¡ ×œ××¢×§×‘ ×”×™×•××™ ğŸ˜‰\n"
        f"(×”×¤×¢×œ×ª ××ª /start {where})"
    )


# ---------- ×¢×–×¨: ×˜×¢×™× ×ª ×•×©××™×¨×ª ××©×ª××©×™× ----------


def load_users() -> dict[int, str]:
    if not os.path.exists(USERS_FILE):
        return {}
    with open(USERS_FILE, "r", encoding="utf-8") as f:
        data = json.load(f)
    # JSON ×©×•××¨ ××¤×ª×—×•×ª ×›××—×¨×•×–×•×ª -> ×××™×¨×™× ×—×–×¨×” ×œ-int
    return {int(k): v for k, v in data.items()}


def save_users(users: dict[int, str]) -> None:
    # ×××™×¨×™× ××¤×ª×—×•×ª ×œ-str ×‘×©×‘×™×œ JSON
    data = {str(k): v for k, v in users.items()}
    with open(USERS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# ---------- ×¤×§×•×“×•×ª ×©×™××•×©×™×•×ª ----------


async def myid(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    await update.message.reply_text(f"×”-ID ×©×œ×š ×”×•×: {user.id}")


async def register(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user

    users = context.bot_data.setdefault("users", {})
    display_name = user.first_name or user.username or str(user.id)
    users[user.id] = display_name

    # ×œ×©××•×¨ ×œ×§×•×‘×¥ ×›×“×™ ×©×™×™×©××¨ ×’× ××—×¨×™ restart
    save_users(users)

    await update.message.reply_text(f"{display_name}, × ×¨×©××ª ×œ××¢×§×‘ ×”×™×•××™ âœ…")


async def shaming(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global QUIZ_CHAT_ID
    user = update.effective_user

    # ×¨×§ ×”×‘×¢×œ×™× ×¨×©××™ ×œ×”×¤×¢×™×œ ××ª ×”×¤×§×•×“×”
    if user.id != OWNER_ID:
        await update.message.reply_text("×”×¤×§×•×“×” ×”×–×• ×œ× ×‘×©×‘×™×œ×š ğŸ˜‰")
        return

    if QUIZ_CHAT_ID is None:
        await update.message.reply_text("×× ×™ ×œ× ××›×™×¨ ×¢×“×™×™×Ÿ ××ª ×”×§×‘×•×¦×”. ×ª×¢×©×” /start ×‘×ª×•×š ×”×§×‘×•×¦×” ×¤×¢× ××—×ª.")
        return

    if not context.args:
        await update.message.reply_text("×ª×›×ª×•×‘: /shaming ×©×_××•_×›×™× ×•×™")
        return

    target_name = " ".join(context.args)

    text = (
        f"××” ×”×œ×•×– {target_name}?? "
        f"××ª/×” ×œ×•××“/×ª ×œ×—×•×•×™×” ××•×–×™×§×œ×™×ª ×‘×›×œ×œ??"
    )

    # ×©×•×œ×— ××ª ×”×”×•×“×¢×” *×œ×§×‘×•×¦×”* ×©× ×©××¨×”, ×œ× ×œ×¦'××˜ ×©××× ×• ×©×œ×—×ª ××ª ×”×¤×§×•×“×”
    await context.bot.send_message(
        chat_id=QUIZ_CHAT_ID,
        text=text,
    )


# ---------- /quiz â€“ ×©××œ×” ××—×ª, ×‘××—×–×•×¨ ×¢×œ ×›×œ ×”×××’×¨ ----------


async def quiz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    ×©××œ×” ××—×ª ××”×××’×¨, ××‘×œ ×‘××§×•× random ×˜×”×•×¨:
    ×× ×—× ×• ×©×•××¨×™× ××—×–×•×¨ ×©×œ ×›×œ ×”×©××œ×•×ª ×•×¢×•×‘×¨×™× ×¢×œ×™×”×Ÿ ×œ×¤× ×™ ×©×™×© ×—×–×¨×•×ª.
    """
    # × ×™×”×•×œ "××—×–×•×¨" ×©×œ ×›×œ ×”×©××œ×•×ª
    cycle = context.bot_data.get("quiz_cycle")
    if not cycle:
        # ×™×•×¦×¨×™× ×œ×™×¡×˜ ×¢× ×›×œ ×”××™× ×“×§×¡×™× ×•××¢×¨×‘×‘×™×
        cycle = list(range(len(questions)))
        random.shuffle(cycle)
        context.bot_data["quiz_cycle"] = cycle

    idx = cycle.pop()
    q = questions[idx]

    message = await context.bot.send_poll(
        chat_id=update.effective_chat.id,
        question=q["question"],
        options=q["options"],
        type="quiz",
        correct_option_id=q["correct_index"],
        is_anonymous=False,
    )

    polls = context.bot_data.setdefault("polls", {})
    poll_id = message.poll.id
    polls[poll_id] = {
        "question": q["question"],
        "options": q["options"],
        "correct_index": q["correct_index"],
        "is_exam": False,  # ×¡×ª× ×©××œ×” ×¨×’×™×œ×”
    }


# ---------- ××‘×—× ×™× ×’×œ×•×‘×œ×™×™×: /quiz20 ×•-/quiz_all ----------


async def send_exam_questions(
    context: ContextTypes.DEFAULT_TYPE,
    chat_id: int,
    question_indices: list[int],
) -> None:
    """
    ×©×•×œ×— ××ª ×›×œ ×©××œ×•×ª ×”××‘×—×Ÿ (20 ××• ×›×œ ×”×××’×¨) ×‘×‘×ª ××—×ª ×œ×¦'××˜,
    ×•×©×•××¨ mapping ×©×œ poll_id -> ××™×“×¢ ×¢×œ ×”×©××œ×” + ×©×™×•×š ×œ××‘×—×Ÿ.
    """
    exam = context.bot_data.get("current_exam")
    if not exam:
        return

    total = len(question_indices)
    polls = context.bot_data.setdefault("polls", {})

    for i, idx in enumerate(question_indices):
        q = questions[idx]
        number = i + 1
        question_text = f"×©××œ×” {number} ××ª×•×š {total}:\n{q['question']}"

        message = await context.bot.send_poll(
            chat_id=chat_id,
            question=question_text,
            options=q["options"],
            type="quiz",
            correct_option_id=q["correct_index"],
            is_anonymous=False,
        )

        poll_id = message.poll.id
        exam["poll_ids"].append(poll_id)

        polls[poll_id] = {
            "question": q["question"],
            "options": q["options"],
            "correct_index": q["correct_index"],
            "is_exam": True,   # ×©××œ×” ×©×©×™×™×›×ª ×œ××‘×—×Ÿ
        }


async def quiz20(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    ××‘×—×Ÿ ×©×œ 20 ×©××œ×•×ª â€“ ×’×œ×•×‘×œ×™ ×‘×¦'××˜ (×§×‘×•×¦×” ××• ×¤×¨×˜×™):
    - ×”×©××œ×•×ª × ×œ×§×—×•×ª ××××’×¨ ××—×–×•×¨×™ ×›×“×™ ×œ×›×¡×•×ª ××ª ×›×œ ×”×©××œ×•×ª ×œ××•×¨×š ×–××Ÿ.
    - ×©×•× ×©××œ×” ×œ× "× ×–×¨×§×ª": ×ª××™×“ ××¡×™×™××™× ××—×–×•×¨ ×œ×¤× ×™ ×©××ª×—×™×œ×™× ×—×“×©.
    - ×©×•×œ×— ××ª ×›×œ 20 ×”×©××œ×•×ª ×‘×‘×ª ××—×ª.
    - ×›×œ ××™ ×©×™×¢× ×” ×¢×œ ×›×œ ×”-20 ×™×§×‘×œ ×¦×™×•×Ÿ ××™×©×™ ×‘×¤×¨×˜×™.
    """
    chat = update.effective_chat
    chat_id = chat.id

    num_questions = 20
    total_questions = len(questions)

    if total_questions < num_questions:
        await update.message.reply_text("××™×Ÿ ××¡×¤×™×§ ×©××œ×•×ª ×‘×©×‘×™×œ 20 ×›×¨×’×¢ ğŸ™‚")
        return

    # ×× ×›×‘×¨ ×™×© ××‘×—×Ÿ ×¤×¢×™×œ â€“ ×œ× × ×¤×ª×— ×¢×•×“ ××—×“
    if context.bot_data.get("current_exam"):
        await update.message.reply_text("×›×‘×¨ ×¨×¥ ××‘×—×Ÿ ×›×¨×’×¢. ×¡×™×™××• ××•×ª×• ×œ×¤× ×™ ×©××ª×—×™×œ×™× ×—×“×© ğŸ™‚")
        return

    # ===== ×××’×¨ ××—×–×•×¨×™ ×œ-/quiz20 =====
    # quiz20_cycle: ××” × ×©××¨ ×‘××—×–×•×¨ ×”× ×•×›×—×™ (×¤×¨××•×˜×¦×™×” ×©×œ ×›×œ ××™× ×“×§×¡×™ ×”×©××œ×•×ª).
    cycle = context.bot_data.get("quiz20_cycle")

    if not cycle:
        # ×”×ª×—×œ×”: ×‘×•× ×™× ××—×–×•×¨ ××œ× ×©×œ ×›×œ ×”×©××œ×•×ª
        cycle = list(range(total_questions))
        random.shuffle(cycle)

    indices: list[int] = []

    # 1. ×§×•×“× × ×©×ª××© *×¢×“ ×”×¡×•×£* ×‘××” ×©× ×©××¨ ×‘××—×–×•×¨ ×”× ×•×›×—×™
    while cycle and len(indices) < num_questions:
        indices.append(cycle.pop())

    # 2. ×× ×¢×“×™×™×Ÿ ×—×¡×¨×•×ª ×©××œ×•×ª ×œ××‘×—×Ÿ â€“ ××ª×—×™×œ×™× ××—×–×•×¨ ×—×“×© ××œ×
    while len(indices) < num_questions:
        new_cycle = list(range(total_questions))
        random.shuffle(new_cycle)
        context.bot_data["quiz20_cycle"] = new_cycle  # ×–×” ×¢×›×©×™×• ×”××—×–×•×¨ ×”×—×“×©
        cycle = new_cycle

        # ×××©×™×›×™× ×œ×§×—×ª ××”××—×–×•×¨ ×”×—×“×© ×¢×“ ×©××’×™×¢×™× ×œ-20
        while cycle and len(indices) < num_questions:
            indices.append(cycle.pop())

    # ×©×•××¨×™× ××ª ×”××¦×‘ ×”××¢×•×“×›×Ÿ ×©×œ ×”××—×–×•×¨ (×™×›×•×œ ×œ×”×™×•×ª ×©× ×©××¨×• ×‘×• ×©××œ×•×ª ×œ×¢×ª×™×“)
    context.bot_data["quiz20_cycle"] = cycle

    # ×”×’×“×¨×ª ×”××‘×—×Ÿ ×”× ×•×›×—×™
    context.bot_data["current_exam"] = {
        "questions_indices": indices,
        "poll_ids": [],
        "total": num_questions,
        "chat_id": chat_id,
        "answers_by_poll": {},  # poll_id -> { user_id: is_correct }
        "graded_users": set(),  # ××™ ×©×›×‘×¨ ×§×™×‘×œ ×¦×™×•×Ÿ
    }

    await update.message.reply_text(
        "××ª×—×™×œ×™× ××‘×—×Ÿ ×©×œ 20 ×©××œ×•×ª! ğŸ§\n"
        "×›×œ ×©××œ×” = 5 × ×§×³.\n"
        "×”×©××œ×•×ª ×‘××‘×—×Ÿ × ×‘×—×¨×•×ª ×××—×–×•×¨ ×©××›×¡×” ××ª *×›×œ* ×”×©××œ×•×ª ×‘×•×•×“××•×ª ğŸ“š\n"
        "×›×œ ××™ ×©×™×¢× ×” ×¢×œ ×›×œ ×”-20 ×™×§×‘×œ ×¦×™×•×Ÿ ××™×©×™ ×‘×¤×¨×˜×™ ğŸ™‚"
    )

    await send_exam_questions(context, chat_id, indices)


async def quiz_all(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    ××‘×—×Ÿ ×¢×œ ×›×œ ×”×××’×¨ â€“ /quiz_all:
    - ×©×•×œ×— ××ª ×›×œ ×”×©××œ×•×ª ×‘×‘×ª ××—×ª.
    - ××™ ×©×™×¢× ×” ×¢×œ ×›×•×œ×Ÿ ×™×§×‘×œ ×¦×™×•×Ÿ ××™×©×™.
    """
    chat = update.effective_chat
    chat_id = chat.id

    num_questions = len(questions)
    if num_questions == 0:
        await update.message.reply_text("××™×Ÿ ×©××œ×•×ª ×‘×××’×¨ ×›×¨×’×¢ ğŸ™‚")
        return

    if context.bot_data.get("current_exam"):
        await update.message.reply_text("×›×‘×¨ ×¨×¥ ××‘×—×Ÿ ×›×¨×’×¢. ×¡×™×™××• ××•×ª×• ×œ×¤× ×™ ×©××ª×—×™×œ×™× ×—×“×© ğŸ™‚")
        return

    indices = list(range(len(questions)))
    random.shuffle(indices)

    context.bot_data["current_exam"] = {
        "questions_indices": indices,
        "poll_ids": [],
        "total": num_questions,
        "chat_id": chat_id,
        "answers_by_poll": {},
        "graded_users": set(),
    }

    await update.message.reply_text(
        f"××ª×—×™×œ×™× ××‘×—×Ÿ ×¢×œ ×›×œ ×”×—×•××¨! ğŸ“\n"
        f"×™×© {num_questions} ×©××œ×•×ª.\n"
        "×›×œ ××™ ×©×™×¢× ×” ×¢×œ ×›×•×œ×Ÿ ×™×§×‘×œ ×¦×™×•×Ÿ ××™×©×™ ×‘×¤×¨×˜×™ ğŸ™‚"
    )

    await send_exam_questions(context, chat_id, indices)


# ---------- Poll Answer â€“ ×œ×•×’×™×§×ª ×ª×©×•×‘×•×ª ----------


async def handle_poll_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global last_practice

    answer = update.poll_answer
    user = answer.user
    poll_id = answer.poll_id
    chosen_options = answer.option_ids

    if not chosen_options:
        return

    chosen_index = chosen_options[0]

    polls = context.bot_data.get("polls", {})
    poll_info = polls.get(poll_id)
    if not poll_info:
        return

    correct_index = poll_info["correct_index"]
    options = poll_info["options"]
    correct_text = options[correct_index]
    chosen_text = options[chosen_index]

    # ×¡×™××•×Ÿ ×©×ª×¨×’×œ ×”×™×•×
    today = datetime.date.today().isoformat()
    last_practice[user.id] = today

    # ×”×•×“×¢×” ×¤×¨×˜×™×ª ×¢×œ × ×›×•×Ÿ/×œ×
    if chosen_index == correct_index:
        text = f"âœ”ï¸ × ×›×•×Ÿ! ×”×ª×©×•×‘×” ×”×™×: {correct_text}"
        is_correct = True
    else:
        text = (
            "âŒ ×œ× ××“×•×™×§...\n"
            f"××ª×” ×¡×™×× ×ª: {chosen_text}\n"
            f"×”×ª×©×•×‘×” ×”× ×›×•× ×”: {correct_text}"
        )
        is_correct = False

    try:
        await context.bot.send_message(chat_id=user.id, text=text)
    except Exception as e:
        logging.warning(f"×œ× ×”×¦×œ×—×ª×™ ×œ×©×œ×•×— ×”×•×“×¢×” ×¤×¨×˜×™×ª ×œ{user.id}: {e}")

    # ===== ×œ×•×’×™×§×ª ××‘×—×Ÿ ×’×œ×•×‘×œ×™ (/quiz20, /quiz_all) =====
    exam = context.bot_data.get("current_exam")
    if not exam:
        return

    # ×× ×”×¡×§×¨ ×”×–×” ×‘×›×œ×œ ×œ× ×©×™×™×š ×œ××‘×—×Ÿ ×”× ×•×›×—×™ â€“ ××ª×¢×œ××™×
    if not poll_info.get("is_exam") or poll_id not in exam.get("poll_ids", []):
        return

    answers_by_poll: dict[str, dict[int, bool]] = exam.setdefault("answers_by_poll", {})
    poll_answers = answers_by_poll.setdefault(poll_id, {})
    poll_answers[user.id] = is_correct

    total = exam["total"]

    # ×›××” ×©××œ×•×ª ×”××©×ª××© ×”×–×” ×¢× ×” ×‘××‘×—×Ÿ?
    answered = 0
    correct_count = 0
    for p_id in exam["poll_ids"]:
        user_answers = answers_by_poll.get(p_id, {})
        if user.id in user_answers:
            answered += 1
            if user_answers[user.id]:
                correct_count += 1

    # ×× ×”××©×ª××© ×¢× ×” ×¢×œ ×›×œ ×”×©××œ×•×ª ×•×¢×“×™×™×Ÿ ×œ× ×§×™×‘×œ ×¦×™×•×Ÿ â€“ ×©×•×œ×—×™×
    graded_users: set[int] = exam.setdefault("graded_users", set())
    if answered == total and user.id not in graded_users:
        score = correct_count * 5  # ×›×œ ×©××œ×” = 5 × ×§'
        msg = (
            f"×¡×™×™××ª ××ª ×”××‘×—×Ÿ! ğŸ‰\n"
            f"×¢× ×™×ª × ×›×•×Ÿ ×¢×œ {correct_count} ××ª×•×š {total}.\n"
            f"×§×™×‘×œ×ª {score} × ×§×•×“×•×ª."
        )
        try:
            await context.bot.send_message(chat_id=user.id, text=msg)
            graded_users.add(user.id)
        except Exception as e:
            logging.warning(f"×œ× ×”×¦×œ×—×ª×™ ×œ×©×œ×•×— ×¦×™×•×Ÿ ×œ{user.id}: {e}")


# ---------- ×©×™×™××™× ×’ ×™×•××™ ----------


async def daily_shaming(context: ContextTypes.DEFAULT_TYPE):
    global QUIZ_CHAT_ID, last_practice

    if QUIZ_CHAT_ID is None:
        return

    users = context.bot_data.get("users", {})
    if not users:
        return

    today = datetime.date.today().isoformat()

    lazy_users = [
        name
        for user_id, name in users.items()
        if last_practice.get(user_id) != today
    ]

    if not lazy_users:
        # ×›×•×œ× ×ª×¨×’×œ×•, ×›×œ ×”×›×‘×•×“ ğŸ˜‡
        return

    text_lines = ["×©×™×™××™× ×’ ×™×•××™ ğŸ¯"]
    for name in lazy_users:
        text_lines.append(f"{name}, ××” ×§×•×¨×”? ×¢×•×“ ×œ× ×ª×¨×’×œ×ª ×”×™×•×. ×××›×–×‘ ×¤×” ××ª ×›×•×œ×... ğŸ¤¨")

    text = "\n".join(text_lines)

    try:
        await context.bot.send_message(chat_id=QUIZ_CHAT_ID, text=text)
    except Exception as e:
        logging.warning(f'×œ× ×”×¦×œ×—×ª×™ ×œ×©×œ×•×— ×©×™×™××™× ×’ ×œ×§×‘×•×¦×”: {e}')


async def debug_shaming(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global QUIZ_CHAT_ID, last_practice

    users = context.bot_data.get("users", {})
    today = datetime.date.today().isoformat()

    lazy_users = [
        f"{user_id} ({name})"
        for user_id, name in users.items()
        if last_practice.get(user_id) != today
    ]

    text = (
        f"QUIZ_CHAT_ID = {QUIZ_CHAT_ID}\n"
        f"users = {users}\n"
        f"last_practice = {last_practice}\n"
        f"lazy_users today = {lazy_users}"
    )

    await update.message.reply_text(text)


# ---------- main ----------


def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # ×˜×•×¢×Ÿ ××©×ª××©×™× ×¨×©×•××™× ×-users.json (×œ× ××•×—×§ ×•×œ× ××©× ×” ×¤×•×¨××˜!)
    app.bot_data["users"] = load_users()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("quiz", quiz))
    app.add_handler(CommandHandler("quiz20", quiz20))
    app.add_handler(CommandHandler("quiz_all", quiz_all))
    app.add_handler(CommandHandler("register", register))
    app.add_handler(CommandHandler("debug_shaming", debug_shaming))
    app.add_handler(CommandHandler("myid", myid))
    app.add_handler(CommandHandler("shaming", shaming))

    app.add_handler(PollAnswerHandler(handle_poll_answer))

    job_queue = app.job_queue
    job_queue.run_daily(
        daily_shaming,
        time=datetime.time(hour=15, minute=0),  # 15:00 ×œ×¤×™ ×”×©×¢×•×Ÿ ×©×œ ×”××—×©×‘ ×©×œ×š / Railway
    )

    app.run_polling()


if __name__ == "__main__":
    main()
